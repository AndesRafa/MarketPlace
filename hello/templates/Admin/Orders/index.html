{% include "header.html" %}

    <section>
        <div class="section white-background p-t-100 p-b-100">
            <div class="container">
                <!-- Heading Section-->
                <div class="heading-section-1">
                    <h3>Ordenes</h3>
                </div>
                <div class="section white-background" style="margin-top: 30px">
                    <table id="freeze-table" class="table table-condensed table-striped">
                        <thead>
                            <tr>
                                <th>N Pedido</th>
                                <th>Costo</th>
                                <th>Estado</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="orders">

                        </tbody>
                    </table>
                    <!--table class="table table-condensed table-striped">
                        <thead>
                            <tr>
                                <th>CÃ³digo</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Operaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>h</td>
                                <td>h</td>
                                <td>h</td>
                                <td>h</td>
                                <td>h</td>
                                <td>h</td>
                                <td>h</td>
                            </tr>
                            <tr>
                                <td>h</td>
                                <td>h</td>
                                <td>h</td>
                                <td>h</td>
                                <td>h</td>
                                <td>h</td>
                                <td>h</td>
                            </tr>
                                {#% for test in tests %#}
                                <tr>
                                    <td>{{ test.number }}</td>
                                    <td>{{ test.name }}</td>
                                    <td>{{ test.category }}</td>
                                    <td>{{ test.labs }}</td>
                                    <td>{{ test.description }}</td>
                                    <td>{{ test.minimum_sample }}</td>
                                </tr>
                            {#% endfor %#}
                        </tbody>
                    </table-->
                </div>
            </div>
        </div>
    </section>

    <script>
        $( document ).ready(function() {
            var url =  window.location.origin + "/api/";
            var url2 = window.location.origin + "/";
            var  _doAjax = function (sType, uri, data, fnSuccess, fnError, _async) {
                 if (!data) data = {};
                 if (!fnError) fnError = function (err) {
                     console.log(err);
                 };
                 if (!_async) _async = true;
                 $.ajax({
                     type: sType,
                     url: uri,
                     data: data,
                     async: _async,
                     contentType: "application/json; charset=utf-8",
                     dataType: "json",
                     success: fnSuccess,
                     error: fnError
                 });
            };

            var selectedOrder = {};

            var getCurrency = function (value) {
                return '$' + value.toFixed(2).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
            };

            var getDetails = function (order) {
                selectedOrder = order;
                var tbody = "";
                var total = 0;
                $.each(order.items, function( index, value ) {
                    total += value.quantityTotal*value.product.price;
                    tbody +=   "<tr>"
                             +   "<td>" + value.product.name + "</td>"
                             +   "<td>" + value.quantityTotal + "</td>"
                             +   "<td>" + getCurrency(value.product.price) +"</td>"
                             + "</tr>"
                });
                $( "#nOrder" ).empty().append( order.id );
                $( "#user" ).empty().append( order.orders[0].Username );
                $( "#products" ).empty().append( tbody );
                $( "#totalOrder" ).empty().append( getCurrency (total) );
                $( "#dateOrder" ).empty().append( order.createdDate );
                //console.log(order.orders[0].Status)
                $("#lstatus option").filter(function() {
                    //may want to use $.trim in here
                    return $(this).text() == order.orders[0].Status;
                }).prop('selected', true);
                //$("#divlstatus select").text(order.orders[0].Status);
                //$('#divlstatus option:contains(' + order.orders[0].Status + ')');
            };

            var updateOrder = function () {
                //console.log( $('#lstatus').find(":selected").val());
                var status = $('#lstatus').find(":selected").val();
                if(status == 0) {
                    alert("Seleccione un estado!");
                    return;
                }
                var order = {};
                order.id = selectedOrder.orders[0].id
                order.user = selectedOrder.orders[0].idUser;
                order.status = status;
                order.statusDate = new Date();
                order.schedule = selectedOrder.orders[0].idSchedule ;
                order.paymentMethod = selectedOrder.orders[0].idPaymentMethod;
                order.shoppingCart = selectedOrder.orders[0].ShoppingCart;
                //console.log(JSON.stringify( order ));
                _doAjax("POST"
                        ,url2 + "updateOrder"
                        ,JSON.stringify( order )
                        ,function (resp) {
                            //console.log(resp)
                            $('#details').modal('toggle');
                            getOrders();
                        }
                        ,function (err) {
                            console.log(err);
                            $('#details').modal('toggle');
                            getOrders();
                        }
                        ,true);
            };

            $( "#updateOrder" ).click(function() {
                updateOrder();
            });

            var getOrders = function () {
                _doAjax("GET", url + "shoppingcar",{},function (resp) {
                    //console.log(resp)
                    var tbody = "";
                    $.each(resp, function( index, value ) {
                        var total = 0;
                        //console.log(value)
                        $.each(value.items, function( index2, value2 ) {
                            //console.log(value2)
                            total += value2.quantityTotal*value2.product.price;
                        });
                        tbody = tbody
                            + "<tr>"
                            + "<td>" + value.id + "</td>"
                            + "<td>" + getCurrency(total) + "</td>"
                            + "<td>" + value.orders[0].Status + "</td>"
                            + "<td id='" + value.id + "'><a href='#' data-toggle='modal' data-target='#details'>Cambiar Estado</a>" + "</td>"
                            + "</tr>";
                    });
                    //console.log(tbody)
                    $( "#orders" ).empty().append( tbody );

                    $('td').click(function () {
                        var col = $(this).parent().children().index($(this));
                        //console.log(col)
                        //console.log($(this).attr("id"))
                        if( col == 3) {
                             _doAjax("GET", url + "shoppingcar/" + $(this).attr("id"),{},function (resp) {
                                 //console.log(resp);
                                 getDetails(resp);
                             },null,true);
                        }
                    });

                },null,true);
            };
            var getOrderStatus = function () {
                _doAjax("GET", url + "orderstatus",{},function (resp) {
                    //console.log(resp)
                    var options = $("#lstatus");
                    $.each(resp, function() {
                        options.append($("<option />").val(this.id).text(this.status));
                    });
                },null,true);
            };
            getOrders();
            getOrderStatus();
        });
    </script>

    <!-- Modal -->
    <div id="details" class="modal fade" role="dialog">
      <div class="modal-dialog modal-lg">

        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Detalle de pedido # <span id="nOrder"></span> </h4>
          </div>
          <div class="modal-body">
              <strong>Usuario: </strong><span id="user"> </span>
              <table class="table table-condensed table-striped">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio</th>
                    </tr>
                </thead>
                <tbody id="products">

                </tbody>
              </table>
              <strong> Total: </strong> <span id="totalOrder" ></span> <br>
              <strong> Fecha: </strong> <span id="dateOrder" ></span> <br> <br>
              <div id="divlstatus" class="form-group">
                 <label for="sel1"><strong> Estado: </strong> </label>
                 <select class="form-control" id="lstatus">
                     <option selected value="0">Seleccione un estado</option>
                 </select>
              </div>
          </div>
          <div class="modal-footer">
              <button id="updateOrder" type="button" class="btn btn-default" >Guardar</button>
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>

      </div>
    </div>

{% include "footer.html" %}